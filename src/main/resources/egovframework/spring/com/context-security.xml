<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:security="http://www.springframework.org/schema/security"
	xmlns:egov-security="http://maven.egovframe.go.kr/schema/egov-security"
	xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security.xsd
		http://maven.egovframe.go.kr/schema/egov-security http://maven.egovframe.go.kr/schema/egov-security/egov-security-4.1.0.xsd">

	<security:http pattern="/common/**" security="none" />
	<security:http pattern="/css/**" security="none" />
	<security:http pattern="/html/**" security="none" />
	<security:http pattern="/images/**" security="none" />
	<security:http pattern="/js/**" security="none" />
	<security:http pattern="/resource/**" security="none" />
	<security:http pattern="\A/WEB-INF/jsp/.*\Z" request-matcher="regex" security="none" />

	<security:authentication-manager>
		<security:authentication-provider>
			<security:password-encoder ref="passwordEncoder" />
			<security:jdbc-user-service data-source-ref="egov.dataSource"
				users-by-username-query="
		        SELECT USERNAME, PASSWORD, CASE WHEN ENABLED=1 THEN 1 ELSE 0 END
		        FROM USERS WHERE USERNAME = ?"
				authorities-by-username-query="
        		SELECT USERNAME, AUTHORITY FROM AUTHORITIES WHERE USERNAME = ?" 
        	/>
		</security:authentication-provider>
	</security:authentication-manager>
	
	<security:global-method-security pre-post-annotations="enabled" proxy-target-class="true">
    	<security:expression-handler ref="methodExprHandler"/>
	</security:global-method-security>

	<security:http use-expressions="true">
		<security:expression-handler ref="webExprHandler"/>
		<security:csrf disabled="true" />
		<security:intercept-url pattern="/login.do"  access="permitAll"/>
		<security:intercept-url pattern="/employee/join.do" access="hasRole('ROLE_ADMIN')"/>
  		<security:intercept-url pattern="/admin/security/**" access="hasRole('ROLE_ADMIN')"/>
	    <security:intercept-url pattern="/admin/employee/**" access="hasAnyRole('ROLE_HR','ROLE_ADMIN')"/>
	    <security:intercept-url pattern="/admin/attendance/**" method="GET" access="hasAnyRole('ROLE_HR','ROLE_ADMIN','ROLE_AUDITOR')"/>
	    <security:intercept-url pattern="/admin/attendance/**" method="POST" access="hasAnyRole('ROLE_HR','ROLE_ADMIN')"/>
	    <security:intercept-url pattern="/admin/leave/**" access="hasAnyRole('ROLE_HR','ROLE_ADMIN')"/>
	    <security:intercept-url pattern="/admin/report/**" access="hasAnyRole('ROLE_ADMIN','ROLE_AUDITOR','ROLE_HR','ROLE_MANAGER')"/>
	    <security:intercept-url pattern="/attendance/**" access="hasRole('ROLE_USER')"/>
	    <security:intercept-url pattern="/leave/**" access="hasRole('ROLE_USER')"/>
	    <security:intercept-url pattern="/internal/**" access="hasRole('ROLE_SYSTEM')"/>
	    <security:intercept-url pattern="/batch/**"    access="hasRole('ROLE_SYSTEM')"/>
	    <security:intercept-url pattern="/main.do" access="isAuthenticated()"/>
	    <security:intercept-url pattern="/**"      access="isAuthenticated()"/>
		<security:intercept-url pattern="/**" access="isAuthenticated()"/>
		<security:form-login login-page="/login.do"
							 login-processing-url="/loginProcess.do" 
							 default-target-url="/main.do"
							 authentication-success-handler-ref="customLoginSuccessHandler"
							 authentication-failure-url="/login.do?error=true"
							 username-parameter="username" 
							 password-parameter="password" />
		<security:logout logout-url="/logout.do"
						 logout-success-url="/login.do?logout=true"
						 invalidate-session="true" />
		<security:session-management invalid-session-url="/login.do?expired=1">
			<security:concurrency-control max-sessions="1" error-if-maximum-exceeded="false" />
		</security:session-management>
	</security:http>
	
	<bean id="methodExprHandler" class="org.springframework.security.access.expression.method.DefaultMethodSecurityExpressionHandler">
    	<property name="roleHierarchy" ref="roleHierarchy"/>
	</bean>
	
	<bean id="roleHierarchy" class="org.springframework.security.access.hierarchicalroles.RoleHierarchyImpl"/>

	<bean id="roleHierarchyRefresher" class="egovframework.let.attendance.security.RoleHierarchyRefresher" init-method="refresh">
		<!-- <property name="roleHierarchy" ref="roleHierarchy"/> -->
	</bean>
	
	<bean id="webExprHandler" class="org.springframework.security.web.access.expression.DefaultWebSecurityExpressionHandler">
    	<property name="roleHierarchy" ref="roleHierarchy"/>
	</bean>

	<!-- URL에 세미콜론(semicolon)허용 여부(기본값/false) -->
	<bean id="egovStrictHttpFirewall" class="org.springframework.security.web.firewall.StrictHttpFirewall">
		<property name="allowSemicolon" value="true" />
	</bean>
	<security:http-firewall ref="egovStrictHttpFirewall" />

	<bean id="customLoginSuccessHandler" class="egovframework.let.attendance.handler.CustomLoginSuccessHandler"/>
</beans>
