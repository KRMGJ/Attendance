<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper
	namespace="egovframework.let.attendance.repository.mybatis.AttendanceDAO">

	<!-- Attendance + Employee 연계 매핑 -->
	<resultMap id="AttendanceWithEmpMap"
		type="egovframework.let.attendance.entity.Attendance">
		<id property="id" column="a_id" />
		<result property="empId" column="a_emp_id" />
		<result property="workDate" column="a_work_date" />
		<result property="checkIn" column="a_check_in" />
		<result property="checkOut" column="a_check_out" />
		<result property="status" column="a_status" />
		<result property="overtimeMinutes" column="a_overtime_minutes" />
		<association property="employee"
			javaType="egovframework.let.attendance.entity.Employee">
			<id property="id" column="e_id" />
			<result property="name" column="e_name" />
			<result property="email" column="e_email" />
		</association>
	</resultMap>

	<resultMap id="MonthlyDeptReportMap"
		type="egovframework.let.attendance.dto.response.MonthlyDeptReportDto">
		<result property="department" column="department" />
		<result property="headcount" column="headcount" />
		<result property="workDays" column="work_days" />
		<result property="totalMinutes" column="total_minutes" javaType="int" />
		<result property="totalOvertime" column="total_overtime" javaType="int" />
		<result property="nightOvertime" column="night_overtime" javaType="int" />
		<result property="weekendOvertime" column="weekend_overtime" javaType="int" />
		<result property="lateCount" column="late_cnt" />
		<result property="earlyLeaveCount" column="early_leave_cnt" />
		<result property="absentCount" column="absent_cnt" />
		<result property="leaveDays" column="leave_days" />
		<result property="sickLeaveDays" column="sick_leave_days" />
		<result property="avgMinutes" column="avg_minutes" javaType="int" />
		<result property="avgOvertimePerCapita"
			column="avg_overtime_pc" javaType="int" />
	</resultMap>

	<!-- 관리자용 출퇴근기록 조회 -->
	<select id="countAdmin" resultType="long">
		SELECT COUNT(1)
		FROM ATTENDANCE a
		JOIN EMPLOYEE e ON e.id = a.emp_id
		<where>
			<if test="kw != null and kw != ''">
				AND (LOWER(e.name) LIKE #{kw} OR LOWER(e.email) LIKE
				#{kw})
			</if>
			<if test="from != null">
				AND a.work_date &gt;= #{from}
			</if>
			<if test="to != null">
				AND a.work_date &lt;= #{to}
			</if>
		</where>
	</select>

	<!-- 관리자용 출퇴근기록 페이징 조회 -->
	<select id="selectAdminPage" resultMap="AttendanceWithEmpMap">
		SELECT * FROM (
		SELECT t.*, ROWNUM rn FROM (
		SELECT
		a.id AS a_id,
		a.emp_id AS a_emp_id,
		a.work_date AS a_work_date,
		a.check_in AS
		a_check_in,
		a.check_out AS a_check_out,
		a.status AS a_status,
		a.overtime_minutes AS a_overtime_minutes,
		e.id AS e_id,
		e.name AS
		e_name,
		e.email AS e_email
		FROM ATTENDANCE a
		JOIN EMPLOYEE e ON e.id =
		a.emp_id
		<where>
			<if test="kw != null and kw != ''">
				AND (LOWER(e.name) LIKE #{kw} OR LOWER(e.email) LIKE
				#{kw})
			</if>
			<if test="from != null">
				AND a.work_date &gt;= #{from}
			</if>
			<if test="to != null">
				AND a.work_date &lt;= #{to}
			</if>
		</where>
		ORDER BY a.work_date DESC, e.name ASC
		) t
		WHERE ROWNUM &lt;= #{offset} +
		#{limit}
		)
		WHERE rn &gt; #{offset}
	</select>

	<!-- 개인용 출퇴근기록 기간 조회 -->
	<select id="findMyRange" resultMap="AttendanceWithEmpMap">
		SELECT
		a.id AS a_id, a.emp_id
		AS a_emp_id, a.work_date AS a_work_date,
		a.check_in AS a_check_in,
		a.check_out AS a_check_out,
		a.status AS a_status, a.overtime_minutes AS
		a_overtime_minutes,
		e.id AS e_id, e.name AS e_name, e.email AS e_email
		FROM ATTENDANCE a
		JOIN EMPLOYEE e ON e.id = a.emp_id
		WHERE e.emp_id =
		#{empId}
		AND a.work_date BETWEEN #{from} AND #{to}
		ORDER BY a.work_date
		ASC
	</select>

	<select id="selectMonthlyDeptReport" parameterType="map"
		resultMap="MonthlyDeptReportMap">
		WITH A AS (
		SELECT e.department,
		a.emp_id,
		a.work_date,
		a.check_in,
		a.check_out,
		a.status,
		NVL(a.overtime_minutes,0) AS overtime_minutes
		FROM ATTENDANCE a
		JOIN EMPLOYEE e ON e.id = a.emp_id
		WHERE a.work_date BETWEEN #{start,jdbcType=DATE} AND #{end,jdbcType=DATE}
		),
		L AS (
		/* 승인된 휴가의 해당 월 교집합 일수 합산 */
		SELECT e.department,
		SUM(GREATEST(0,
		( LEAST(l.end_date, #{end,jdbcType=DATE})
		- GREATEST(l.start_date, #{start,jdbcType=DATE}) + 1))) AS leave_days,
		SUM(CASE WHEN l.type = '병가' THEN
		GREATEST(0,
		( LEAST(l.end_date, #{end,jdbcType=DATE})
		- GREATEST(l.start_date, #{start,jdbcType=DATE}) + 1))
		ELSE 0 END) AS sick_leave_days
		FROM LEAVE_REQUEST l
		JOIN EMPLOYEE e ON e.id = l.emp_id
		WHERE l.status = 'APPROVED'
		AND l.start_date &lt;= #{end,jdbcType=DATE}
		AND l.end_date &gt;= #{start,jdbcType=DATE}
		GROUP BY e.department
		),
		D AS (
		/* 부서 단위 근무·연장·지각·조퇴·결근 집계 */
		SELECT department,
		COUNT(DISTINCT emp_id) AS headcount,
		COUNT(CASE WHEN status IN ('정상 출근','지각','조퇴') THEN 1 END) AS work_days,
		/* 총 근무분 = TRUNC((check_out - check_in)*24*60) */
		SUM(CASE WHEN status IN ('정상 출근','지각','조퇴')
		THEN NVL(TRUNC( (CAST(check_out AS DATE) - CAST(check_in AS DATE)) * 24 *
		60 ), 0)
		ELSE 0 END) AS total_minutes,
		/* 총 연장분 정수화 */
		SUM(NVL(TRUNC(overtime_minutes),0)) AS total_overtime,
		/* 야간: 22~05 사이 */
		SUM(CASE WHEN
		( (check_out IS NOT NULL AND TO_NUMBER(TO_CHAR(check_out,'HH24'))
		BETWEEN 22 AND 23)
		OR
		(check_in IS NOT NULL AND TO_NUMBER(TO_CHAR(check_in,'HH24')) BETWEEN 0 AND 5)
		)
		THEN NVL(TRUNC(overtime_minutes),0) ELSE 0 END) AS night_overtime,
		/* 주말 연장: 토/일 */
		SUM(CASE WHEN TO_CHAR(work_date,'DY','NLS_DATE_LANGUAGE=ENGLISH') IN
		('SAT','SUN')
		THEN NVL(TRUNC(overtime_minutes),0) ELSE 0 END) AS weekend_overtime,
		SUM(CASE WHEN status='지각' THEN 1 ELSE 0 END) AS late_cnt,
		SUM(CASE WHEN status='조퇴' THEN 1 ELSE 0 END) AS early_leave_cnt,
		SUM(CASE WHEN status='결근' THEN 1 ELSE 0 END) AS absent_cnt
		FROM A
		GROUP BY department
		)
		SELECT d.department,
		d.headcount,
		NVL(d.work_days,0) AS work_days,
		NVL(d.total_minutes,0) AS total_minutes,
		NVL(d.total_overtime,0) AS total_overtime,
		NVL(d.night_overtime,0) AS night_overtime,
		NVL(d.weekend_overtime,0) AS weekend_overtime,
		NVL(d.late_cnt,0) AS late_cnt,
		NVL(d.early_leave_cnt,0) AS early_leave_cnt,
		NVL(d.absent_cnt,0) AS absent_cnt,
		NVL(l.leave_days,0) AS leave_days,
		NVL(l.sick_leave_days,0) AS sick_leave_days,
		/* 파생 평균값(분) */
		CASE WHEN d.headcount &gt; 0 THEN
		FLOOR(NVL(d.total_minutes,0)/d.headcount) ELSE 0 END AS avg_minutes,
		CASE WHEN d.headcount &gt; 0 THEN
		FLOOR(NVL(d.total_overtime,0)/d.headcount) ELSE 0 END AS
		avg_overtime_pc
		FROM D d
		LEFT JOIN L l ON l.department = d.department
		ORDER BY d.department
	</select>


</mapper>
