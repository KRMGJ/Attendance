<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="employeeDAO">

	<resultMap id="EmployeeViewMap" type="egovframework.let.attendance.dto.response.EmployeeViewDto">
		<id property="id" column="ID" />
		<result property="name" column="NAME" />
		<result property="email" column="EMAIL" />
		<result property="position" column="POSITION" />
		<result property="department" column="DEPARTMENT" />
		<result property="employmentType" column="EMPLOYMENT_TYPE" />
		<result property="status" column="STATUS" />
		<result property="hireDate" column="HIRE_DATE" jdbcType="TIMESTAMP" />
		<result property="resignDate" column="RESIGN_DATE" jdbcType="TIMESTAMP" />
		<result property="updatedAt" column="UPDATED_AT" jdbcType="TIMESTAMP" />
	</resultMap>

	<select id="selectViewById" parameterType="string" resultMap="EmployeeViewMap">
		SELECT ID, NAME, EMAIL, POSITION, DEPARTMENT, EMPLOYMENT_TYPE, STATUS,
		HIRE_DATE, RESIGN_DATE,
		UPDATED_AT
		FROM EMPLOYEE
		WHERE ID = #{id}
	</select>

	<select id="existsByEmailExcludingId" resultType="int">
		SELECT COUNT(1)
		FROM EMPLOYEE
		WHERE EMAIL = #{email} AND ID &lt;&gt; #{id}
	</select>

	<select id="canEdit" resultType="int">
		SELECT CASE
		WHEN EXISTS (
		SELECT 1
		FROM AUTHORITIES WHERE USERNAME = #{actorUsername} AND AUTHORITY IN
		('ROLE_ADMIN','ADMIN')
		) THEN 1
		WHEN EXISTS (
		SELECT 1
		FROM EMPLOYEE E
		JOIN USERS U ON U.USERNAME = E.EMAIL
		WHERE E.ID = #{id} AND U.USERNAME
		= #{actorUsername}
		) THEN 1
		ELSE 0
		END AS OK
		FROM DUAL
	</select>

	<update id="updateProfile" parameterType="egovframework.let.attendance.dto.request.EditEmployeeDto">
		UPDATE EMPLOYEE
		SET NAME = #{name},
		EMAIL = #{email},
		POSITION = #{position},
		EMPLOYMENT_TYPE = #{employmentType},
		UPDATED_AT
		= #{updatedAt, jdbcType=TIMESTAMP}
		WHERE ID = #{id}
	</update>

	<update id="updatePassword">
		<!-- 직원 비밀번호 보관 위치 정책: 1) EMPLOYEE 테이블에 PASSWORD 컬럼이 있다면 거기에 저장 2) Spring 
			Security JDBC를 쓰는 경우 USERS 테이블을 갱신 -->
		UPDATE EMPLOYEE
		SET PASSWORD = #{password},
		UPDATED_AT = #{updatedAt,
		jdbcType=TIMESTAMP}
		WHERE ID = #{id}
	</update>

	<select id="countList" resultType="long">
		SELECT COUNT(*)
		FROM employee e
		<where>
			<if test="kw != null">
				(LOWER(e.name) LIKE #{kw} OR LOWER(e.email) LIKE #{kw})
			</if>
			<if test="dept != null">
				AND e.department = #{dept}
			</if>
			<if test="status != null">
				AND e.status = #{status}
			</if>
		</where>
	</select>

	<select id="selectListPage" resultType="egovframework.let.attendance.entity.Employee">
		SELECT * FROM (
		SELECT t.*, ROWNUM rn FROM (
		SELECT e.id, e.name, e.email, e.department, e.employment_type, e.position, e.status,
		e.hire_date, e.resign_date, e.updated_at
		FROM employee e
		<where>
			<if test="kw != null">
				(LOWER(e.name) LIKE #{kw} OR LOWER(e.email) LIKE #{kw})
			</if>
			<if test="dept != null">
				AND e.department = #{dept}
			</if>
			<if test="status != null">
				AND e.status = #{status}
			</if>
		</where>
		ORDER BY e.updated_at DESC
		) t
		WHERE ROWNUM &lt;= #{offset} + #{limit}
		)
		WHERE rn &gt; #{offset}
	</select>


</mapper>
